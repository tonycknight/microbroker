name: Build & Release

permissions:
  actions: read
  pull-requests: write
  security-events: write
  contents: write
  checks: write

on:
  push:
    branches: [ "**" ]
    tags: [ "**" ]
  workflow_dispatch:
  merge_group:

env:
  build-version-number: 0.0.${{ github.run_number }}  
  docker-image-name: ghcr.io/tonycknight/microbroker
  
jobs:
  sca:
    name: SCA
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v5
              
      - name: pkgchk
        uses: tonycknight/pkgchk-action@v1
        with: 
          scan-issues: true
          scan-upgrades: true
          vulnerable: true
          deprecated: true
          transitives: true
    
  
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v5
              
      - name: Run build
        run: |
            dotnet tool restore
            dotnet build -c Release

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v5
                      
      - name: Tests
        run: |
          dotnet tool restore
          dotnet test -c Debug --filter FullyQualifiedName~unit --logger "trx;LogFileName=test_results.trx" /p:CollectCoverage=true /p:CoverletOutput=./TestResults/coverage.info /p:CoverletOutputFormat=cobertura

      - name: Consolidate code coverage
        run: |
          dotnet reportgenerator -reports:"./tests/**/coverage.info" -targetdir:"./publish/codecoverage" -reporttypes:"Html"
          dotnet reportgenerator -reports:"./tests/**/coverage.info" -targetdir:"./publish/codecoveragedata" -reporttypes:"Cobertura"

      - name: Archive Test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: unit-tests_results
          path: |
            ./tests/**/TestResults/*
            
      - name: Archive Code coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: Full_code_coverage_report
          path: ./publish/codecoverage/*.*
                    
      - name: Unit test results
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Unit test results
          path: ${{ github.workspace }}/tests/*.tests.unit/TestResults/test_results.trx
          reporter: dotnet-trx
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Code coverage summary
        uses: 5monkeys/cobertura-action@master
        if: always()
        with:
          path: ${{ github.workspace }}/publish/codecoveragedata/Cobertura.xml
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          minimum_coverage: 0
          fail_below_threshold: true
          show_line: true
          show_branch: true
          show_missing: true
          show_class_names: true
          skip_covered: false
          link_missing_lines: true
          report_name: Code coverage summary

  acceptance-tests:
    name: Run acceptance tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Build docker image
        run: docker build -f Dockerfile -t microbroker:localbuild --build-arg BuildVersion=0.0.0-localbuild .

      - name: Set docker network
        run: |
          echo "docker-network=microbroker-acceptance-tests-${{ github.run_number }}" >> $GITHUB_ENV
          docker network create -d bridge ${{ env.docker-network }}

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.12.1
        with:
          mongodb-version: latest # ${{ matrix.mongodb-version }}
          docker-network: ${{ env.docker-network }}

      - name: Start microbroker
        run: |
          docker run --name microbroker-acceptancetests --detach --network=${{ env.docker-network }} -it --rm -p 8080:8080 microbroker:localbuild

      - name: Run Tests
        run: |
          dotnet test --filter FullyQualifiedName~acceptance

      - name: Stop microbroker
        if: always()
        run: |
          docker stop microbroker-acceptancetests
          docker network rm ${{ env.docker-network }} --force

  build-publish-docker-image:
    name: Build & Publish docker image
    runs-on: ubuntu-latest
    needs:   [ build, unit-tests, sca, acceptance-tests ]

    steps:
      - uses: actions/checkout@v6
      
      - name: Set BuildVersion
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          echo "build-version-number=$(git describe --tags --dirty)" >> $GITHUB_ENV

      - name: Report version
        run: echo "Building package ${{ env.build-version-number }}" >> $GITHUB_STEP_SUMMARY

      - name: Set Docker image name
        run: |
          echo "docker-image-name=${{ env.docker-image-name }}:v${{ env.build-version-number }}" >> $GITHUB_ENV
                  
      - name: Build docker image
        run: docker build -f Dockerfile -t ${{ env.docker-image-name }} --build-arg BuildVersion=${{ env.build-version-number }} .

      - name: Login to GitHub Container Registry
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR }}

      - name: Push docker image
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: docker push ${{ env.docker-image-name }}
